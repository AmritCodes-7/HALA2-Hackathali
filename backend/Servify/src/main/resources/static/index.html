<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>HospitalAgent WebSocket Test</title>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <style>
      body {
        font-family: Arial, sans-serif;
        background: #0f172a;
        color: #e5e7eb;
        padding: 20px;
      }
      input,
      button {
        padding: 8px;
        margin: 4px;
      }
      #chat {
        border: 1px solid #334155;
        padding: 10px;
        height: 300px;
        overflow-y: auto;
        margin-top: 10px;
        background: #020617;
      }
      .msg {
        margin-bottom: 6px;
      }
      .public {
        color: #22c55e;
      }
      .private {
        color: #38bdf8;
      }
      .hidden {
        display: none;
      }
    </style>
  </head>

  <body>
    <h2>ü©∫ HospitalAgent WebSocket Tester</h2>

    <!-- LOGIN SECTION -->
    <div id="loginSection">
      <h3>üîê Login</h3>
      <input id="loginUsername" placeholder="Username" />
      <input id="loginPassword" type="password" placeholder="Password" />
      <button onclick="login()">Login</button>
      <div id="loginStatus"></div>
    </div>

    <hr />

    <!-- CHAT SECTION -->
    <div id="chatSection" class="hidden">
      <h3>WebSocket</h3>
      <button onclick="connect()">Connect WebSocket</button>

      <h3>Public Message</h3>
      <input id="publicMsg" placeholder="Message to everyone" />
      <button onclick="sendPublic()">Send Public</button>

      <h3>Private Message</h3>
      <input id="receiver" placeholder="Receiver username" />
      <input id="privateMsg" placeholder="Private message" />
      <button onclick="sendPrivate()">Send Private</button>

      <div id="chat"></div>
    </div>

    <script>
      let stompClient = null;
      let currentUser = null;

      /* ================= LOGIN ================= */

      function login() {
        const username = document.getElementById("loginUsername").value;
        const password = document.getElementById("loginPassword").value;

        fetch("http://localhost:8080/api/v1/auth/login", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            username: username,
            password: password,
          }),
        })
          .then((res) => {
            if (!res.ok) throw new Error("Login failed");
            return res.json();
          })
          .then((data) => {
            localStorage.setItem("jwt", data.token);
            currentUser = username;

            document.getElementById("loginStatus").innerText =
              "‚úÖ Logged in as " + username;

            document.getElementById("chatSection").classList.remove("hidden");
          })
          .catch((err) => {
            document.getElementById("loginStatus").innerText =
              "‚ùå Invalid credentials";
          });
      }

      /* ================= WEBSOCKET ================= */

      function connect() {
        const token = localStorage.getItem("jwt");
        if (!token) {
          alert("Login first!");
          return;
        }

        const socket = new SockJS("http://localhost:8080/ws");
        stompClient = Stomp.over(socket);

        stompClient.connect(
          {
            Authorization: "Bearer " + token,
          },
          () => {
            log(`Connected as ${currentUser}`);

            stompClient.subscribe("/public/all", (msg) => {
              const body = JSON.parse(msg.body);
              log(`[PUBLIC] ${body.sender}: ${body.content}`, "public");
            });

            stompClient.subscribe("/user/queue/specific", (msg) => {
              const body = JSON.parse(msg.body);
              log(`[PRIVATE] ${body.sender}: ${body.content}`, "private");
            });
          },
        );
      }

      function sendPublic() {
        const content = document.getElementById("publicMsg").value;

        stompClient.send(
          "/app/chat",
          {},
          JSON.stringify({
            content: content,
          }),
        );
      }

      function sendPrivate() {
        const content = document.getElementById("privateMsg").value;
        const receiver = document.getElementById("receiver").value;

        stompClient.send(
          "/app/private",
          {},
          JSON.stringify({
            receiver: receiver,
            content: content,
          }),
        );
      }

      function log(message, type = "") {
        const div = document.createElement("div");
        div.className = `msg ${type}`;
        div.innerText = message;
        document.getElementById("chat").appendChild(div);
      }
    </script>
  </body>
</html>
